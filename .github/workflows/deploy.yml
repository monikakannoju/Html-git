name: üöÄ Deploy Static Website to VM

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  SERVER_IP: 135.235.195.123
  SERVER_USER: user_1
  APP_NAME: static-site

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v3

    - name: üß© Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts
    
    - name: üîç Test SSH Connection
      run: |
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "echo '‚úÖ SSH connection successful!' && hostname"
    
    - name: üìÇ Create Deployment Directory
      run: |
        ssh $SERVER_USER@$SERVER_IP "mkdir -p /home/$SERVER_USER/static-site"
    
    - name: üì§ Copy Files to Server (using rsync)
      run: |
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./Html-git/Html/ \
          $SERVER_USER@$SERVER_IP:/home/$SERVER_USER/static-site/
    
    - name: üöÄ Deploy Docker Container
      run: |
        ssh $SERVER_USER@$SERVER_IP << 'ENDSSH'
          cd /home/user_1/static-site
          
          echo "üõë Stopping old container..."
          docker stop static-site 2>/dev/null || true
          docker rm static-site 2>/dev/null || true
          
          echo "üßπ Removing old image..."
          docker rmi static-site 2>/dev/null || true
          
          echo "üî® Building Docker image..."
          docker build -t static-site .
          
          echo "üöÄ Starting container..."
          docker run -d \
            --name static-site \
            --restart unless-stopped \
            -p 80:80 \
            static-site
          
          echo "üîç Verifying deployment..."
          sleep 2
          docker ps | grep static-site
          
          echo "‚úÖ Deployment complete!"
ENDSSH
    
    - name: üìä Deployment Summary
      if: success()
      run: |
        echo "### üéâ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Server:** $SERVER_IP" >> $GITHUB_STEP_SUMMARY
        echo "- **Application:** $APP_NAME" >> $GITHUB_STEP_SUMMARY
        echo "- **URL:** http://$SERVER_IP" >> $GITHUB_STEP_SUMMARY
