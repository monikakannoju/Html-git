name: ğŸš€ CI/CD:Deploy Static Website to VM using Docker + Nginx

on:
  push:
    branches: [ "main" ]  # Run when you push to main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SERVER_IP: 135.235.195.123
      SERVER_USER: user_1

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”‘ Configure SSH
      run: |
        eval "$(ssh-agent -s)"
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' | ssh-add -
        mkdir -p ~/.ssh
        ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

    - name: ğŸ” Test SSH connection
      run: |
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "echo 'âœ… SSH connection successful from GitHub Actions!' && hostname && whoami"

    - name: ğŸ³ Deploy Docker static site
      run: |
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
        set -e

        echo "ğŸ”¹ Creating deployment directory..."
        mkdir -p /home/$USER/static-site
        cd /home/$USER/static-site

        echo "ğŸ”¹ Stopping any old container..."
        docker stop static-site || true
        docker rm static-site || true

        echo "ğŸ”¹ Copying static HTML from repo..."
        rm -rf *
        mkdir -p html
        cd html

        cat > index.html <<'HTML'
        <!DOCTYPE html>
        <html>
        <head><title>Static Website</title></head>
        <body>
          <h1>ğŸš€ CI/CD Static Website deployed via GitHub Actions!</h1>
          <p>Server: $(hostname)</p>
        </body>
        </html>
        HTML

        cd ..
        echo "ğŸ”¹ Creating Dockerfile..."
        cat > Dockerfile <<'DOCKER'
        FROM nginx:alpine
        COPY html /usr/share/nginx/html
        EXPOSE 80
        DOCKER

        echo "ğŸ”¹ Building Docker image..."
        docker build -t static-site .

        echo "ğŸ”¹ Running container on port 80..."
        docker run -d --name static-site -p 80:80 static-site

        echo "âœ… Deployment completed successfully!"
        EOF
