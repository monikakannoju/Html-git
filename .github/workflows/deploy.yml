name: üöÄ Deploy Static Website to VM

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  SERVER_IP: 135.235.195.123
  SERVER_USER: user_1
  APP_NAME: static-site

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v3

    - name: üß© Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_ed25519
        ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

    - name: üîç Test SSH Connection
      run: |
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "echo '‚úÖ SSH connection works!' && hostname && whoami"

    - name: üì¶ Build Docker Image
      run: |
        docker build -t $APP_NAME Html-git/Html/

    - name: üì§ Deploy to VM
      run: |
        # Copy project files to VM
        scp -o StrictHostKeyChecking=no -r Html-git/Html/* $SERVER_USER@$SERVER_IP:/home/$SERVER_USER/static-site/

        # Connect and deploy container
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << EOF
          cd /home/$SERVER_USER/static-site

          echo "üõë Stopping old container (if any)..."
          docker stop $APP_NAME || true
          docker rm $APP_NAME || true

          echo "‚öôÔ∏è Building new Docker image..."
          docker build -t $APP_NAME .

          echo "üöÄ Running new container..."
          docker run -d --name $APP_NAME -p 80:80 $APP_NAME

          echo "‚úÖ Deployment Complete!"
        EOF
